# Home Tasks Telegram Bot

Бот помогает распределять домашние дела между участниками, отправляет ежедневные напоминания и собирает статистику по выполнению задач.

## Возможности

- Ротация комнат между участниками каждую неделю.
- Автоматический выбор уровня уборки (ежедневный минимум, легкая, обычная, расширенная, генеральная).
- Ежедневные персональные сообщения в 10:00 и вечерние напоминания в 20:00.
- Инлайн‑кнопки для отметки задач как выполненных.
- Сводка по выполненным задачам в общем чате и команда `/admin` для просмотра статистики.
- Данные пользователей и список задач в JSON, отметки — в SQLite.

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Настройка

1. Скопируйте файл `.env`:
   ```bash
   cp cleaning_bot/.env.example .env
   ```
2. Укажите токен телеграм‑бота в переменной `TELEGRAM_BOT_TOKEN`.
3. Отредактируйте `cleaning_bot/config.yaml`:
   - `group_chat_id` — ID общего чата.
   - `admin_ids` — список ID администраторов.
   - При необходимости измените расписание уведомлений.
4. Обновите `cleaning_bot/users.json`, чтобы указать участников (ID и имя).
5. Обновите `cleaning_bot/tasks.json`, чтобы описать комнаты и уровни уборки.

### Как получить `chat_id`

1. Добавьте бота в нужный групповой чат и отправьте в нём любое сообщение (это создаст обновление для бота).
2. Откройте в браузере или через `curl` запрос `https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates`.
3. В ответе найдите блок `"chat": { "id": ... }` — это ID чата. Скопируйте его в `group_chat_id` внутри `cleaning_bot/config.yaml`.
4. Если ответ выглядит как `{"ok":true,"result":[]}`, значит у бота ещё нет новых обновлений. Убедитесь, что он добавлен в чат и после этого повторно отправьте в чат сообщение/команду (при необходимости отключите режим Privacy в BotFather, чтобы бот получал все сообщения).


## Запуск

```bash
python -m cleaning_bot.bot
```

Бот запустится в режиме long polling. Для продакшена рекомендуется настроить systemd‑сервис или Docker‑контейнер на виртуальной машине.

## Структура проекта

```
cleaning_bot/
├── bot.py            # Точка входа и инициализация приложения
├── config.py         # Загрузка настроек из YAML и .env
├── data_loaders.py   # Работа с файлами users.json и tasks.json
├── database.py       # Хранилище на SQLite
├── dispatcher.py     # Хэндлеры Telegram и генерация задач
├── scheduler.py      # Планировщик на APScheduler
├── tasks.json        # Описание задач по комнатам
├── users.json        # Список участников
├── utils.py          # Форматирование сообщений
├── config.yaml       # Основные настройки
└── .env.example      # Пример переменных окружения
```

## Тестирование

```bash
pytest
```

Тесты проверяют логику ротации и генерации задач.

## Дополнительно

- Таблица `assignments` хранит ежедневные задачи и отметки о выполнении.
- Команда `/admin` выводит статистику выполненных задач за текущую неделю.
