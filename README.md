# Home Tasks Telegram Bot

Бот помогает распределять домашние дела между участниками, отправляет ежедневные напоминания и собирает статистику по выполнению задач.

## Возможности

- Ротация комнат между участниками каждую неделю.
- Автоматический выбор уровня уборки (базовый минимум, легкая, обычная, расширенная, генеральная).
- Утреннее сообщение в 10:00 в общем чате с приветствием и актуальными задачами с кнопками.
- Личные напоминания в 18:00 тем, у кого остались невыполненные дела.
- Вечерний отчёт в 22:00 в общем чате с итогами за день и смайликами прогресса.
- Инлайн‑кнопки для отметки задач как выполненных.
- Сводка по выполненным задачам в общем чате и команда `/stats` для просмотра прогресса.
- Команда `/tasks` моментально присылает актуальные задания (в личке персонально, в группе — отдельные блоки с кнопками для каждого участника).
- Данные пользователей и список задач в JSON, отметки — в SQLite.

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Настройка

1. Скопируйте файл `.env`:
   ```bash
   cp cleaning_bot/.env.example .env
   ```
2. Укажите токен телеграм‑бота в переменной `TELEGRAM_BOT_TOKEN`.
3. Отредактируйте `cleaning_bot/config.yaml`:
   - `group_chat_id` — ID общего чата.
   - `admin_ids` — список ID администраторов.
   - При необходимости измените расписание уведомлений (`daily_notification_time`, `reminder_time`, `report_time`).
4. Обновите `cleaning_bot/users.json`, чтобы указать участников (ID и имя).
5. Обновите `cleaning_bot/tasks.json`, чтобы описать комнаты и уровни уборки.

### Как получить `chat_id`

**Рекомендуемый способ:**

1. Добавьте бота в нужный чат и убедитесь, что ваш Telegram ID есть в `bot.admin_ids`.
2. В личном чате или в самом групповом чате отправьте команду `/chatid`.
3. Бот ответит сообщением вида `ID этого чата: <число>`. Для группового чата перенесите это значение в `bot.group_chat_id` внутри `cleaning_bot/config.yaml`.

**Альтернативный способ через `getUpdates`:**

1. Временно остановите запущенный бот (например, остановите systemd-сервис или процесс `python -m cleaning_bot.bot`).
2. Отправьте в целевой чат любое сообщение.
3. Выполните запрос `https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates` и найдите `"chat": { "id": ... }`.
4. После получения ID снова запускайте бота. Одновременно работать может только один long polling клиент; иначе Telegram вернёт ошибку `Conflict: terminated by other getUpdates request`.


## Запуск

```bash
python -m cleaning_bot.bot
```

Бот запустится в режиме long polling. Для продакшена рекомендуется настроить systemd‑сервис или Docker‑контейнер на виртуальной машине.

Подробная инструкция по развёртыванию на одной VM через `systemd` и `python -m venv` находится в [docs/deployment/systemd.md](docs/deployment/systemd.md).

## Структура проекта

```
cleaning_bot/
├── bot.py            # Точка входа и инициализация приложения
├── config.py         # Загрузка настроек из YAML и .env
├── data_loaders.py   # Работа с файлами users.json и tasks.json
├── database.py       # Хранилище на SQLite
├── dispatcher.py     # Хэндлеры Telegram и генерация задач
├── scheduler.py      # Планировщик на APScheduler
├── tasks.json        # Описание задач по комнатам
├── users.json        # Список участников
├── utils.py          # Форматирование сообщений
├── config.yaml       # Основные настройки
└── .env.example      # Пример переменных окружения
```

## Тестирование

```bash
pytest
```

Тесты проверяют логику ротации и генерации задач.

## Дополнительно

- Таблица `assignments` хранит ежедневные задачи и отметки о выполнении.
- Команда `/stats` выводит статистику выполненных задач за неделю и текущий месяц.
- В 22:00 бот автоматически присылает в общий чат отчёт по завершённым задачам за текущий день.
